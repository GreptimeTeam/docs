# Upgrade

From `v0.4`, we provide a built-in utility to help upgrade your previous GreptimeDB deployment to the latest version if there are some breaking changes.
It's recommended to use this method to upgrade your GreptimeDB with different versions.

The lowest version that can be upgraded by this tool is `v0.3.0`.

## CLI

This tool is in the `greptime` binary. You need to prepare the corresponding binary of target version before start.

```shell
greptime cli export --help
```

And the help text is as follows:

```shell
greptime-cli-export 

USAGE:
    greptime cli export [OPTIONS] --addr <ADDR> --output-dir <OUTPUT_DIR> --target <TARGET>

OPTIONS:
      --addr <ADDR>
          Server address to connect

      --output-dir <OUTPUT_DIR>
          Directory to put the exported data. E.g.: /tmp/greptimedb-export

      --database <DATABASE>
          The name of the catalog to export
          
          [default: greptime-*]

  -j, --export-jobs <EXPORT_JOBS>
          Parallelism of the export
          
          [default: 1]

      --max-retry <MAX_RETRY>
          Max retry times for each job
          
          [default: 3]

  -t, --target <TARGET>
          Things to export

          Possible values:
          - create-table:  Corresponding to `SHOW CREATE TABLE`
          - table-data:    Corresponding to `EXPORT TABLE`
          - database-data: Corresponding to `EXPORT DATABASE`

      --log-dir <LOG_DIR>
          

      --start-time <START_TIME>
          A half-open time range: [start_time, end_time). The start of the time range (time-index column) for data export

      --end-time <END_TIME>
          A half-open time range: [start_time, end_time). The end of the time range (time-index column) for data export

      --log-level <LOG_LEVEL>
          

      --auth-basic <AUTH_BASIC>
          The basic authentication for connecting to the server

  -h, --help
          Print help (see a summary with '-h')

  -V, --version
          Print version
```

Here explains the meaning of some important options

- `--addr`: The gRPC address of the Frontend node or Standalone process.
- `--output-dir`: The directory to put the exported data. Give a path at your current machine. The exported SQL files will be put in that directory.
- `--target`: The things to export. `create-table` can export the `CREATE TABLE` clause for each table. `database-data` can export the data of each database alone with `COPY FROM` clause.

For a complete upgrade, you will need to execute this tools twice with each target options.

## Upgrade from 0.8.x

Here is a complete example for upgrading from `v0.8.x` to `v0.9.x`.

### Export `CREATE TABLE`

Assuming the HTTP service port of the old database is `4000`.

```shell
greptime cli export --addr '127.0.0.1:4000' --output-dir /tmp/greptimedb-export --target create-table
```

If success, you will see something like this

```log
2023-10-20T09:41:06.500390Z  INFO cmd::cli::export: Finished exporting greptime.public with 434 table schemas to path: /tmp/greptimedb-export/greptime/public
2023-10-20T09:41:06.500482Z  INFO cmd::cli::export: success 1/1 jobs
```

And now the output directory structure is

```plaintext
/tmp/greptimedb-export/
└── greptime/public/
     └── create_tables.sql
```

### Export table data

```shell
greptime cli export --addr '127.0.0.1:4000' --database greptime-public --output-dir /tmp/greptimedb-export --target database-data
```

The log output is similar to the previous one. And the output directory structure is

```plaintext
/tmp/greptimedb-export/
├── greptime/public
│   ├── copy_from.sql
│   ├── create_tables.sql
│   ├── up.parquet
│   └── other-tables.parquet
```

New files are `copy_from.sql` and parquet files of each table. The former one contains the `COPY FROM` clause for each database. The latter one contains the data of each table.

### Import table schema and data

Then you need to execute SQL files generated by the previous step. First is `create_tables.sql`. SQL generated in previous step is in PostgreSQL dialect, we will use [PG protocol](/user-guide/clients/postgresql.md) in the following steps. This document assumes the client is `psql`.

:::tip NOTICE
From this step, all the operation is done in the new version of GreptimeDB.

The default port of PostgreSQL protocol is `4003`.
:::

Before executing the following command, you need first to create the corresponding database in your new deployment (but in this example, the database `greptime-public` is the default one).

This command will create all the tables in the new version of GreptimeDB.

```shell
psql -h 127.0.0.1 -p 4003 -d public -f /tmp/greptimedb-export/greptime/public/create_tables.sql
```

And then import the data

```shell
psql -h 127.0.0.1 -p 4003 -d public -f /tmp/greptimedb-export/greptime/public/copy_from.sql
```

### Clean up

At this step all the data is migrated. You can check the data in the new cluster.

After confirming that the data is correct, you can clean up the old cluster and the temporary `--output-dir`. `/tmp/greptimedb-export` at this example.

## Recommended overall process

This section gives a recommended overall process for upgrading GreptimeDB smoothly. You can skip this section if your environment can go offline on the upgrade progress.

1. Create a brand new v0.9.x cluster.
2. Use the v0.9.x CLI tool to export and import `create-table`.
3. Switch the workload to the new cluster.
4. Use the v0.9.x CLI tool to export and import `database-data`.

Caveats
- Changes to table structure between step 2 and 3 will be lost
- Old data is invisible in new cluster until step 4 is done
