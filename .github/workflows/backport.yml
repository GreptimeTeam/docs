name: Backport on Demand

on:
  issue_comment:
    types: [created]

jobs:
  backport:
    if: ${{
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, 'backport! ')
    }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Extract target version
      id: extract-version
      run: |
        comment_body="${{ github.event.comment.body }}"
        version=$(echo "$comment_body" | sed -nE 's/.*backport![[:space:]]+([^[:space:]]+).*/\1/p')
        if [ -z "$version" ]; then
          echo "⚠️ Failed to extract version from comment: $comment_body"
          exit 1
        fi
        echo "version=${version}" >> $GITHUB_OUTPUT
        echo "Extracted version: ${version}"

    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.issue.pull_request.head.ref }}
        repository: ${{ github.event.issue.pull_request.head.repo.full_name }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run backport command
      run: npm run backport --version ${{ steps.extract-version.outputs.version }} --since main

    - name: Commit changes
      id: commit
      run: |
        if git diff-index --quiet HEAD --; then
          echo "No changes to commit"
          echo "changes=false" >> $GITHUB_OUTPUT
        else
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Backport changes for version ${{ steps.extract-version.outputs.version }}"
          echo "Changes committed"
          echo "changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Push changes
      if: steps.commit.outputs.changes == 'true'
      run: git push
